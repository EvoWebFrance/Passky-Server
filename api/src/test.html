<!doctype html>
<html>
<head>
	<meta charset="UTF-8">
	<title>Passky Server</title>
  <meta name="description" content="Passky is a simple, modern, lightweight, open-source and secure password manager.">
  <meta name="keywords" content="Passky, passky, Password manager, password manager, open source">
  <meta name="author" content="Rabbit Company">
	<style>
		body{
			background-color: #1f2937;
			text-align: center;
			font-family: ui-sans-serif, system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, "Noto Sans", sans-serif, "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol", "Noto Color Emoji";
		}
		h1{
			font-size: 2.25rem;
			line-height: 2.5rem;
			font-weight: 800;
			color: white;
		}
		h2{
			font-size: 1.25rem;
			line-height: 1.5rem;
			font-weight: 500;
			color: white;
		}
		ul{
			text-align: left;
			color: lightgray;
		}
		p{
			color: lightgray;
		}
		a{
			color: lightblue;
		}
		.center{
			margin: auto;
			width: 50%;
		}
	</style>
</head>
<body>
	<div class="center">
		<h1>Passky Server</h1>
		<p>If you see this page, that means your Passky Server has been successfully installed.</p>
		<h1>How do I use it?</h1>
		<h2>1. Download Passky Client</h2>
		<p>Passky Client can be accessed right from the <a href="https://vault.passky.org" target="_blank">Website</a> or it can be downloaded from <a href="https://rabbitstore.org/?app=com.rabbit-company.passky" target="_blank">Rabbit Store</a>.</p>
		<h2>2. Connect to your Passky Server</h2>
		<p>When you open Passky Client, you will see the first field called "Server". In this field enter URL of your Passky Server:</br></br><b style="color: green;" id="server-origin"></b></p>
		<h2>3. Sign in or Sign up</h2>
		<p>Now you can fill rest of the fields and click on "Sign in" or "Sign up" button.</p>
		
		<h1 id="warning" style="color: orange;">Warnings</h1>
		<p><ul id="warning-list"></ul></p>
		<script>
			let domain = window.location.origin;
			let warnings = "";
			let warningHtml = "";
			let serverOrigin = document.getElementById("server-origin"); 
			let warningList = document.getElementById("warning-list");
			let info = [];

			if(!domain.startsWith("https://")){
				serverOrigin.style.color = "orange";
				warningList.innerHTML += "<li style='color: orange'>Secure connection is not estabilished with the server. (Deploy <a href='https://nginxproxymanager.com' target='_blank'>Reverse Proxy</a> and install SSL / TLS certificate)</li>";
			}

			fetch(domain + "?action=getInfo")
			.then(response => {
				if (response.ok) return response.json();
				warningList.innerHTML += "<li style='color: red'>Failed to get response from API endpoint. Make sure <a href='" + domain + "?action=getInfo' target='_blank'>" + domain + "?action=getInfo</a> returns json.</li>";
			}).then(json => {
				if(typeof(json) == 'undefined') return;
				if(typeof(json.error) == 'undefined') return;
				if(json.error == 429){
					warningList.innerHTML += "<li style='color: orange'>API Limiter banned your IP, because you have made too many API calls. Please wait few seconds and refresh the website.</li>";
					return;
				}
				if(json.users == -1){
					warningList.innerHTML += "<li style='color: red'>API can't connect with a database. Make sure that you have configured settings in .env file (Manually, by running installerGUI.sh or installer.sh). It's also possible that database have already been created before with different username or password. This can be solved by changing database password to old one or by removing /passky folder, where your database files are stored. So docker will recreate database with new user and password.</li>";
				}
				if(json.users >= json.maxUsers){
					warningList.innerHTML += "<li style='color: orange'>Users won't be able to create new accounts, because account limit has been reached. You can increase account limit by rerunning the installer or changing settings in .env file manually. You would need to recreate docker containers for changes to apply.</li>";
				}
				checkLatestVersion(json.version);
			});


			if(warningList.innerHTML.length == 0){
				document.getElementById("warning").style.visibility = "hidden";
			}

			document.getElementById("server-origin").innerText = domain;

			function checkLatestVersion(version){
				fetch('https://api.github.com/repos/Rabbit-Company/Passky-Server/releases/latest')
				.then(response => {
					if(response.ok) return response.json();
					warningList.innerHTML += "<li style='color: orange'>Failed to check latest Passky Server version from Github.</li>";
				}).then(json => {
					if(typeof(json) == 'undefined') return;
					if(typeof(json.tag_name) == 'undefined') return;
					if(version != json.tag_name){
						warningList.innerHTML += "<li style='color: orange'>Your Passky Server is outdated. You are running version " + version + ", while version " + json.tag_name + " has already been released.</li>";
					}
				});
			}
		</script>
	</div>
</body>
</html>